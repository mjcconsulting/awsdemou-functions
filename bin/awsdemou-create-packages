#!/bin/bash
#
# AWS Demo University - Create Packages
#

bindir=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )
rootdir=${bindir%/*}
srcdir=$rootdir/src
targetdir=$rootdir/target
timestamp=$(date +%Y%M%d-%H%M%S)

echo "Creating Packages"
echo " - src   : $srcdir"
echo " - target: $targetdir"

pushd $srcdir &> /dev/null
for directory in $(ls -1d */ | sed -E -e '/^[a-z]{1,4}\/$/d;s/\/$//'); do
  echo -n "- $directory... "
  mkdir -p $targetdir/$directory
  (cd $directory; zip -X -r $targetdir/$directory/$timestamp.zip ./* > /dev/null)
  md5=$(md5 -q $targetdir/$directory/$timestamp.zip)
  if [ ! -f $targetdir/$directory/$md5.zip ]; then
    echo "Generated ($md5.zip)"
    mv $targetdir/$directory/$timestamp.zip $targetdir/$directory/$md5.zip
  else
    echo "Unchanged"
  fi
  rm -f $targetdir/$directory/????????-??????.zip
done
popd &> /dev/null
